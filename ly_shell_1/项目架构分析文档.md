# Orange'S操作系统 - Shell扩展版 项目架构分析

## 项目概述

本项目是基于Orange'S操作系统的扩展版本，添加了完整的shell命令支持。系统采用模块化设计，包含引导加载、内核核心、文件系统、内存管理和用户命令等多个子系统，实现了一个功能完整的微型操作系统。

## 详细架构分析

### 1. boot/ 文件夹 - 系统引导加载

| 文件 | 作用 | 详细说明 |
|------|------|---------|
| **boot.asm** | 主引导记录(MBR) | 系统启动时最先执行的代码，负责从硬盘读取加载器到内存并跳转到加载器执行 |
| **boot.bin** | 编译后的MBR二进制文件 | boot.asm编译后的可执行文件，写入硬盘的第一个扇区 |
| **loader.asm** | 系统加载器 | 负责从硬盘读取内核到内存，并设置保护模式，最后跳转到内核执行 |
| **loader.bin** | 编译后的加载器二进制文件 | loader.asm编译后的可执行文件 |
| **include/fat12hdr.inc** | FAT12文件系统头定义 | 定义FAT12文件系统的引导扇区结构 |
| **include/load.inc** | 加载器常量定义 | 定义内核加载地址、文件系统参数等常量 |
| **include/pm.inc** | 保护模式相关定义 | 定义保护模式下的段选择子、门描述符等结构 |

### 2. command/ 文件夹 - shell命令实现

| 文件 | 作用 | 详细说明 |
|------|------|---------|
| **Makefile** | 命令编译规则 | 定义命令程序的编译、链接和安装规则 |
| **echo.c** | 回显命令 | 输出命令行参数到控制台 |
| **ls.c** | 列出目录内容命令 | 读取并显示当前目录中的文件列表及其大小 |
| **pwd.c** | 显示当前目录命令 | 显示当前工作目录的路径 |
| **touch.c** | 创建文件命令 | 在当前目录创建新文件 |
| **remove.c** | 删除文件命令 | 删除指定的文件 |
| **cat.c** | 显示文件内容命令 | 读取并显示指定文件的内容 |
| **edit.c** | 文本编辑命令 | 提供简单的文本编辑功能 |
| **ps.c** | 显示进程状态命令 | 显示系统中当前运行的进程列表 |
| **kill.c** | 终止进程命令 | 根据进程ID终止指定的进程 |
| **start.asm** | 命令程序启动代码 | 为每个命令程序提供启动入口点，设置堆栈等 |

### 3. fs/ 文件夹 - 文件系统实现

| 文件 | 作用 | 详细说明 |
|------|------|---------|
| **main.c** | 文件系统核心 | 实现文件系统的初始化、挂载和核心功能 |
| **open.c** | 文件打开操作 | 实现文件的打开、创建和权限检查 |
| **read_write.c** | 文件读写操作 | 实现文件的读取和写入功能 |
| **link.c** | 文件链接操作 | 实现硬链接和符号链接功能 |
| **misc.c** | 文件系统辅助功能 | 实现文件状态获取、目录操作等辅助功能 |
| **disklog.c** | 磁盘日志功能 | 实现文件系统的日志记录，用于崩溃恢复 |

### 4. include/ 文件夹 - 头文件定义

| 文件/目录 | 作用 | 详细说明 |
|-----------|------|---------|
| **ls.h** | ls命令相关定义 | 定义ls命令使用的常量和结构 |
| **stdio.h** | 标准输入输出 | 定义printf、scanf等标准I/O函数 |
| **string.h** | 字符串处理 | 定义字符串操作函数如strcpy、strcmp等 |
| **sys/config.h** | 系统配置 | 定义系统配置参数，如安装区域位置等 |
| **sys/console.h** | 控制台操作 | 定义控制台的初始化和操作函数 |
| **sys/const.h** | 系统常量 | 定义系统中使用的各种常量 |
| **sys/fs.h** | 文件系统定义 | 定义文件系统的数据结构和操作函数 |
| **sys/global.h** | 全局变量 | 声明系统全局变量 |
| **sys/hd.h** | 硬盘驱动 | 定义硬盘驱动的操作函数和数据结构 |
| **sys/keyboard.h** | 键盘驱动 | 定义键盘驱动的操作函数 |
| **sys/keymap.h** | 键盘映射 | 定义键盘按键到ASCII码的映射表 |
| **sys/proc.h** | 进程管理 | 定义进程控制块(PCB)和进程管理相关结构 |
| **sys/protect.h** | 保护模式 | 定义保护模式下的段描述符、门描述符等 |
| **sys/proto.h** | 函数原型 | 声明系统中所有函数的原型 |
| **sys/sconst.inc** | 系统常量汇编定义 | 汇编语言中使用的系统常量 |
| **sys/tty.h** | 终端管理 | 定义终端设备的管理结构和操作函数 |
| **type.h** | 数据类型定义 | 定义系统中使用的数据类型 |

### 5. kernel/ 文件夹 - 内核核心

| 文件 | 作用 | 详细说明 |
|------|------|---------|
| **main.c** | 内核主函数 | 内核初始化，创建初始进程，启动系统服务 |
| **kernel.asm** | 内核入口 | 内核的汇编入口点，设置堆栈并调用main函数 |
| **kernel.o** | 编译后的内核入口目标文件 | kernel.asm编译后的目标文件 |
| **start.c** | 内核启动 | 内核启动时的初始化工作，如设置中断向量表等 |
| **proc.c** | 进程管理 | 实现进程的创建、调度、切换等功能 |
| **clock.c** | 时钟中断处理 | 实现时钟中断的处理和定时器功能 |
| **keyboard.c** | 键盘中断处理 | 实现键盘中断的处理和按键扫描 |
| **tty.c** | 终端管理 | 实现终端设备的初始化和字符处理 |
| **console.c** | 控制台管理 | 实现控制台的显示和操作功能 |
| **hd.c** | 硬盘驱动 | 实现硬盘的读写操作和中断处理 |
| **i8259.c** | 中断控制器 | 实现8259A中断控制器的初始化和操作 |
| **global.c** | 全局变量定义 | 定义系统全局变量，如进程表、任务表等 |
| **protect.c** | 保护模式实现 | 实现保护模式下的内存保护和权限控制 |
| **systask.c** | 系统任务 | 实现系统服务任务，如文件系统、内存管理等 |
| **klib.c** | 内核库函数 | 内核中使用的C语言库函数 |
| **kliba.asm** | 内核汇编库函数 | 内核中使用的汇编语言库函数 |

### 6. lib/ 文件夹 - 系统调用库

| 文件 | 作用 | 详细说明 |
|------|------|---------|
| **syscall.asm** | 系统调用实现 | 实现系统调用的入口点，处理系统调用的参数传递和返回 |
| **open.c** | 文件打开系统调用 | 实现open系统调用，用于打开或创建文件 |
| **read.c** | 文件读取系统调用 | 实现read系统调用，用于从文件读取数据 |
| **write.c** | 文件写入系统调用 | 实现write系统调用，用于向文件写入数据 |
| **close.c** | 文件关闭系统调用 | 实现close系统调用，用于关闭打开的文件 |
| **unlink.c** | 文件删除系统调用 | 实现unlink系统调用，用于删除文件 |
| **fork.c** | 进程创建系统调用 | 实现fork系统调用，用于创建新进程 |
| **exit.c** | 进程退出系统调用 | 实现exit系统调用，用于终止进程 |
| **wait.c** | 进程等待系统调用 | 实现wait系统调用，用于等待子进程终止 |
| **exec.c** | 程序执行系统调用 | 实现exec系统调用，用于执行新程序 |
| **getpid.c** | 获取进程ID系统调用 | 实现getpid系统调用，用于获取当前进程的ID |
| **stat.c** | 文件状态系统调用 | 实现stat系统调用，用于获取文件的状态信息 |
| **printf.c** | 格式化输出函数 | 实现printf函数，用于格式化输出文本 |
| **vsprintf.c** | 可变参数格式化函数 | 实现vsprintf函数，为printf提供底层支持 |
| **string.asm** | 字符串操作汇编函数 | 实现字符串操作的汇编语言函数 |
| **misc.c** | 其他辅助函数 | 实现其他辅助功能函数 |
| **syslog.c** | 系统日志函数 | 实现系统日志的记录功能 |
| **orangescrt.a** | 编译后的库文件 | 所有库函数编译后链接成的静态库文件 |

### 7. mm/ 文件夹 - 内存管理

| 文件 | 作用 | 详细说明 |
|------|------|---------|
| **main.c** | 内存管理核心 | 实现内存管理的初始化和核心功能 |
| **forkexit.c** | 进程创建和退出时的内存管理 | 处理进程fork和exit时的内存分配和释放 |
| **exec.c** | 程序执行时的内存管理 | 处理exec系统调用时的内存布局和程序加载 |

## 系统启动与执行流程

### 1. 系统引导阶段
1. **BIOS自检**：计算机开机后，BIOS进行自检
2. **读取MBR**：BIOS从硬盘第一个扇区读取MBR(boot.bin)到内存
3. **执行MBR**：MBR代码执行，从硬盘读取加载器(loader.bin)到内存
4. **执行加载器**：加载器设置保护模式，从硬盘读取内核(kernel.bin)到内存
5. **跳转内核**：加载器跳转到内核入口点，开始执行内核代码

### 2. 内核初始化阶段
1. **设置保护模式**：完成内存分段、页表设置等
2. **初始化中断系统**：设置中断向量表，初始化8259A中断控制器
3. **创建系统任务**：创建时钟、键盘、硬盘、文件系统、内存管理等系统任务
4. **初始化内存管理**：设置内存分配器，初始化空闲内存链表
5. **初始化文件系统**：挂载根文件系统，初始化文件系统缓冲区

### 3. 用户环境准备阶段
1. **创建INIT进程**：内核创建第一个用户进程INIT
2. **解压命令程序**：INIT进程从磁盘解压cmd.tar，提取命令程序
3. **创建shell进程**：INIT进程为每个终端创建shell进程
4. **启动shell**：shell进程开始运行，显示命令提示符，等待用户输入

### 4. 用户交互阶段
1. **命令输入**：用户在终端输入命令
2. **命令解析**：shell进程解析命令行，识别命令名称和参数
3. **创建子进程**：shell进程创建子进程来执行命令
4. **执行命令**：子进程通过exec系统调用加载并执行命令程序
5. **等待完成**：shell进程等待子进程执行完成
6. **显示结果**：命令执行结果显示在终端上
7. **循环等待**：shell进程回到等待用户输入的状态

## 命令执行机制

### 命令编译与安装
1. **编译命令**：使用gcc编译命令的C源文件，生成目标文件
2. **链接命令**：将目标文件与启动代码(start.o)和系统库(orangescrt.a)链接，生成可执行文件
3. **打包命令**：将所有命令可执行文件和内核一起打包成inst.tar
4. **写入镜像**：使用dd命令将inst.tar写入80m.img磁盘镜像的指定位置

### 命令执行流程
1. **命令输入**：用户输入命令，如`ls`、`echo hello`等
2. **命令解析**：shell进程解析命令行，分离命令名称和参数
3. **创建子进程**：shell调用fork系统调用创建子进程
4. **加载命令**：子进程调用exec系统调用，从磁盘加载命令程序到内存
5. **执行命令**：命令程序执行其main函数，处理参数，完成相应功能
6. **命令终止**：命令执行完成后，调用exit系统调用终止进程
7. **回收资源**：shell进程调用wait系统调用等待子进程终止，回收其资源
8. **继续等待**：shell进程继续等待用户输入下一个命令

### 命令依赖关系
- **基础命令**（echo、pwd）：仅依赖标准库和基本系统调用
- **文件操作命令**（ls、touch、cat、remove）：依赖文件系统相关系统调用
- **进程管理命令**（ps、kill）：依赖进程管理相关系统调用
- **编辑命令**（edit）：依赖文件系统和终端操作相关系统调用

## 系统调用机制

### 系统调用实现
1. **用户空间调用**：用户程序通过int 0x80指令触发系统调用
2. **中断处理**：CPU跳转到中断处理程序入口（sys_call）
3. **参数传递**：通过寄存器传递系统调用号和参数
4. **调用分发**：根据系统调用号，跳转到相应的系统调用处理函数
5. **内核处理**：内核执行系统调用的具体实现
6. **返回结果**：将执行结果通过寄存器返回给用户程序

### 主要系统调用
| 系统调用 | 功能 | 实现文件 |
|---------|------|---------|
| **open** | 打开或创建文件 | lib/open.c |
| **read** | 读取文件内容 | lib/read.c |
| **write** | 写入文件内容 | lib/write.c |
| **close** | 关闭文件 | lib/close.c |
| **unlink** | 删除文件 | lib/unlink.c |
| **fork** | 创建新进程 | lib/fork.c |
| **exit** | 终止进程 | lib/exit.c |
| **wait** | 等待子进程终止 | lib/wait.c |
| **exec** | 执行新程序 | lib/exec.c |
| **getpid** | 获取进程ID | lib/getpid.c |
| **stat** | 获取文件状态 | lib/stat.c |

## 内存管理机制

### 内存布局
1. **内核空间**：低地址部分，包含内核代码、数据和系统堆栈
2. **用户空间**：高地址部分，每个进程有独立的用户空间
3. **内存分配**：采用空闲块链表管理物理内存，支持动态分配和释放

### 进程内存管理
1. **进程地址空间**：每个进程有独立的虚拟地址空间
2. **内存映射**：将虚拟地址映射到物理地址
3. **堆栈管理**：为每个进程分配用户堆栈
4. **程序加载**：exec系统调用时，加载程序到内存并设置内存布局

## 文件系统机制

### 文件系统结构
1. **超级块**：存储文件系统的基本信息，如inode数量、扇区数量等
2. **inode位图**：记录inode的使用情况
3. **扇区位图**：记录数据扇区的使用情况
4. **inode表**：存储文件的元数据，如文件大小、权限、数据位置等
5. **数据扇区**：存储文件的实际数据
6. **目录项**：存储目录中的文件和子目录信息

### 文件操作
1. **文件打开**：根据文件名查找inode，创建文件描述符
2. **文件读取**：根据inode中的数据位置，从磁盘读取数据
3. **文件写入**：将数据写入磁盘，更新inode中的文件大小和数据位置
4. **文件关闭**：释放文件描述符，刷新缓冲区
5. **文件删除**：释放inode和数据扇区，更新位图

## 总结

本项目实现了一个功能完整的微型操作系统，具有以下特点：

1. **完整的引导加载系统**：从MBR到加载器再到内核的完整引导链
2. **多任务处理能力**：支持进程的创建、调度、切换和管理
3. **基本文件系统**：支持文件的创建、读取、写入、删除和目录操作
4. **shell命令接口**：提供了多个常用的shell命令，如ls、echo、touch等
5. **系统调用机制**：实现了多种系统调用，为用户程序提供服务
6. **内存管理**：支持进程的内存分配和管理
7. **中断处理**：实现了时钟、键盘、硬盘等设备的中断处理

系统采用模块化设计，各个子系统相对独立，便于理解和扩展。命令的实现采用独立可执行文件的方式，使得命令的修改和扩展非常灵活，只需修改对应的命令文件并重新编译安装即可。

这种设计为学习操作系统原理提供了一个很好的实践平台，同时也展示了如何构建一个功能完整的操作系统的基本思路和方法。